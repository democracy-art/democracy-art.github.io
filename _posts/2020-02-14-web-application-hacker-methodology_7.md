---
layout:     post
title:      Web应用程序黑客的方法论(7) --Test for Input-Based Vulnerabilities
subtitle:
date:       2020-02-14
author:     D
header-img: 
catalog: true
mermaid: true
tags:
    - web hacking
---

Web应用程序黑客的方法论来自书本 *The Web Application Hacker's Handbook* <br>

漏洞的许多重要类别是由用户的意外输入触发的，并且可以出现在应用程序中的任何位置。<br>
探测应用程序中这些漏洞的有效方法是使用一组攻击字符串来模糊每个参数到每个请求。<br>

![Testing access controls](/img/test-for-input-based-vulnerabilities.png)

# 7.1 模糊测试所有请求参数(Fuzz All Request Parameters)

7.1.1<br>
查看您的应用程序映射练习的结果，并识别提交服务器端应用程序处理的参数的每个不同的客户端请求。相关参数包括URL查询字符串中的项目，请求正文中的参数和HTTP cookie。还应包括观察到的对应用程序行为有影响的任何其他用户输入项，例如Referer或User-Agent标头。

7.1.2<br>
要模糊化参数，可以使用自己的脚本或现成的模糊化工具。例如，要使用Burp Intruder，请将每个请求依次加载到工具中。一种简单的方法是在Burp Proxy中拦截请求，然后选择Send to Intruder操作，或右键单击Burp Proxy历史记录中的项目，然后选择此选项。使用此选项可使用请求的内容以及正确的目标主机和端口来配置Burp Intruder。 它还会自动将所有请求参数的值标记为有效负载位置，以准备进行模糊测试。

7.1.3<br>
使用有效负载选项卡，配置一组合适的攻击有效负载，以探测应用程序中的漏洞。您可以手动输入有效负载，从文件中加载它们，或选择预设的有效负载列表之一。对应用程序内的每个请求参数进行模糊处理通常需要发出大量请求并检查结果是否存在异常。如果攻击字符串集太大，可能会适得其反，并产生大量的输出供您查看。因此，明智的方法是针对一系列常见漏洞，这些漏洞通常可以在对特定制作的输入的异常响应中容易地检测到，并且通常在应用程序中的任何位置而不是特定功能类型中显现出来。这是一组合适的有效载荷，可用于测试一些常见类别的漏洞：<br>

**SQL Injection** <br>

```
'
'--
'; waitfor delay '0:30:0'--
1; waitfor delay '0:30:0'--
```

**XSS and Header Injection** <br>

```
xsstest
"><script>alert('xss')</script>
```
**Path Traversal**
```
../../../../../../../../../../etc/passwd
../../../../../../../../../../boot.ini
..\..\..\..\..\..\..\..\..\..\etc\passwd
..\..\..\..\..\..\..\..\..\..\boot.ini
```

**Script Injection**
```
;echo 111111
echo 111111
response.write 111111
:response.write 111111
```

**File Inclusion**
```
http://<your server name>/
http://<nonexistent IP address>/
```

7.1.4<br>
前面所有有效载荷均以其原义格式显示。字符 `?` , `;` , `&` , `+` , `=` ,和`空格`需要进行URL编码，因为它们在HTTP请求中具有特殊含义。默认情况下，Burp Intruder对这些字符执行必要的编码，因此请确保未禁用此选项。要在早期定制后将所有选项恢复为默认值，请选择Burp-> Restore Defaults。

7.1.5<br>
在Burp Intruder的Grep函数中，配置一组合适的字符串以在响应中标记一些常见的错误消息。比如:<br>

```
error
exception
illegal
invalid
fail
stack
access
directory
file
not found
varchar
ODBC
SQL
SELECT
111111
```
请注意，包含字符串111111来测试成功的脚本注入攻击。步骤7.1.3中的有效负载涉及将此值写入服务器的响应中。

7.1.6<br>
还选择“有效负载Grep”选项以标记包含有效负载本身的响应，表明潜在的XSS或标头注入漏洞。

7.1.7<br>
在您指定的第一个文件包含有效负载中主机上设置Web服务器或netcat侦听器。这可以帮助您监视由于成功的远程文件包含攻击而导致从服务器收到的连接尝试。

7.1.8<br>
发起攻击。完成后，查看结果以发现异常响应，表明存在漏洞。检查HTTP状态代码，响应长度，响应时间，配置的表达式的外观以及有效负载本身的外观是否存在差异。您可以单击结果表中的每个列标题，以按该列中的值对结果进行排序（然后按住Shift单击以对结果进行反向排序）。这使您可以快速识别与其他结果不同的任何异常。

7.1.9<br>
对于模糊测试结果指示的每个潜在漏洞，请参考此方法的以下部分。它们描述了您应针对每种类型的问题采取的详细步骤，以验证漏洞的存在并成功利用它。

7.1.10<br>
配置Burp Intruder对单个请求执行模糊测试后，您可以在应用程序中的其他请求上快速重复相同的测试。只需在Burp代理中选择每个目标请求，然后选择“Send to Intruder”选项。 然后立即使用现有攻击配置在Intruder中发起攻击。这样，您可以在单独的窗口中同时启动大量测试，并在每个测试完成工作时手动查看结果。

7.1.11<br>
如果您的映射练习发现了任何带外输入通道，可以将用户可控制的输入引入到应用程序的处理中，则应该在这些输入通道上执行类似的模糊测试。提交旨在在Web应用程序中进行处理时触发常见漏洞的各种精心设计的数据。根据输入通道的性质，您可能需要为此创建一个自定义脚本或其他工具。

7.1.12<br>
除了您自己对应用程序请求的模糊处理之外，如果您有权访问自动化的Web应用程序漏洞扫描程序，还应该针对目标应用程序运行它，以提供与自己的发现进行比较的基础。

# 7.2 测试SQL注入(Test for SQL Injection)

7.2.1<br>
如果步骤7.1.3中列出的SQL攻击字符串导致任何异常响应，请手动探测应用程序对相关参数的处理，以确定是否存在SQL注入漏洞。

7.2.2<br>
如果返回了任何数据库错误消息，请调查其含义。使用第9章中的`SQL Syntax and Error Reference`部分可帮助解释某些常见数据库平台上的错误消息。

7.2.3<br>
如果在参数中提交单引号引起错误或其他异常行为，请提交两个单引号。如果此输入导致错误或异常行为消失，则该应用程序可能容易受到SQL注入的攻击。

7.2.4<br>
尝试使用常见的SQL字符串连接器函数来构造与某些良性输入等效的字符串。如果这引起与原始良性输入相同的响应，则该应用程序可能很容易受到攻击。例如，如果原始输入是表达式FOO，则可以使用以下项目执行此测试（在第三个示例中，请注意两个引号之间的空格）:<br>

```
'||'FOO
'+'FOO
' 'FOO
```
与往常一样，请确保对HTTP请求中具有特殊含义的字符（例如`+`和`空格`）进行URL编码。<br>

7.2.5<br>
如果原始输入为数字，请尝试使用与原始值等效的数学表达式。例如，如果原始值为2，请尝试提交1 + 1或3-1。如果应用程序以相同的方式响应，则可能会受到攻击，特别是如果数字表达式的值对应用程序的行为产生系统性影响时。

7.2.6<br>
如果前面的测试成功，则可以通过使用特定于SQL的数学表达式构造特定值来进一步确保涉及SQL注入漏洞。如果可以通过这种方式系统地操纵应用程序的逻辑，那么几乎可以肯定它很容易受到SQL注入的攻击。例如，下面的两个项都是相当于数2:<br>
- `67-ASCII('A')`
- `51-ASCII(1)`

7.2.7<br>
如果使用`waitfor`命令的模糊测试用例中的任何一个导致应用程序响应之前出现异常的时间延迟，这是一个强烈的迹象，表明数据库类型是`MS-SQL`，应用程序很容易受到`SQL注入`的攻击。手动重复测试，在waitfor参数中指定不同的值，并确定响应所花费的时间是否与该值有系统地变化。请注意，您的攻击有效负载可能被插入到多个SQL查询中，因此所观察到的时间延迟可能是所指定值的倍数。

7.2.8<br>
如果应用程序容易受到SQL注入的攻击，请考虑哪些攻击是可行的，哪些攻击可能有助于实现目标。执行下列任何攻击所需的详细步骤请参阅第9章:<br>

- 修改`WHERE`子句中的条件来更改应用程序的逻辑(例如，通过注入`or 1=1--`绕过登录)。
- 使用`UNION`操作符注入一个任意的`SELECT`查询，并将结果与应用程序的原始查询结合起来。
- 使用特定于数据库的SQL语法对数据库类型进行指纹识别。
- 如果数据库类型是`MS-SQL`，应用程序在其响应中返回`ODBC`错误消息，则利用这些消息枚举数据库结构并检索任意数据。
- 如果无法找到直接检索任意注入查询结果的方法，请使用以下高级技术来提取数据;
    - 检索数字形式的字符串数据，一次一个字节。
<br>

[Web应用程序黑客的方法论(6)](https://dm116.github.io/2020/02/13/web-application-hacker-methodology_6/)<br>
[Web应用程序黑客的方法论(8)](https://dm116.github.io/2020/02/14/web-application-hacker-methodology_8/)<br>


